#!/usr/bin/env php
<?php

define('PROJECT_ROOT', realpath(dirname(dirname(__FILE__))));
define('GENERATED_CLASS_DIR', PROJECT_ROOT.'/source/PhysicalQuantity');
define('CONFIG_YAML_PATH', PROJECT_ROOT.'/physical_quantities.yml');

require PROJECT_ROOT.'/vendor/autoload.php';
require PROJECT_ROOT.'/build/ConfigModel.php';

$config = new ConfigModel(CONFIG_YAML_PATH);
$config->parse_intermediate_representation();

print "Clearing generated class directory ".GENERATED_CLASS_DIR."....\n";
clear_generated_class_directory(GENERATED_CLASS_DIR);

print "Rendering base quantities...\n";
render_quantity_classes(
    $config->get_intermediate_representation()['base_quantities'],
    PROJECT_ROOT.'/build/BaseQuantityClass.php.tpl',
    GENERATED_CLASS_DIR
);

print "Rendering derived quantities...\n";
render_quantity_classes(
    $config->get_intermediate_representation()['derived_quantities'],
    PROJECT_ROOT.'/build/BaseQuantityClass.php.tpl',
    GENERATED_CLASS_DIR
);

print "Done.\n";


function clear_generated_class_directory($path)
{
    foreach(array_diff(scandir($path), ['.', '..']) as $file) {
        unlink($path.DIRECTORY_SEPARATOR.$file);
    }
}

function render_quantity_classes($quantities, $template_file_path, $target_dir)
{
    foreach($quantities as $quantity) {
        $content = capture_template($quantity, $template_file_path);

        $file_name = $target_dir.'/'.$quantity['name'].'.php';
        print "    - ".$file_name."\n";

        file_put_contents($file_name, "<?php\n".$content);
    }
}

function capture_template($data, $_template_file_path)
{
    ob_start();
    require $_template_file_path;
    $content = ob_get_contents();
    ob_end_clean();
    return $content;
}
